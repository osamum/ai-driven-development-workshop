name: Azure Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      prefix:
        description: 'ãƒªã‚½ãƒ¼ã‚¹åã®ãƒ—ãƒªãƒ•ã‚£ãƒƒã‚¯ã‚¹ (ä¾‹: mycompany)'
        required: true
        default: 'factory'
      environment:
        description: 'ç’°å¢ƒ (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      deploy_cosmos_db:
        description: 'Cosmos DB ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‹'
        required: true
        default: true
        type: boolean
      deploy_sql_db:
        description: 'SQL Database ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‹'
        required: true
        default: true
        type: boolean

env:
  AZURE_LOCATION: 'japaneast'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Azure ãƒ­ã‚°ã‚¤ãƒ³
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
      run: az --version

    - name: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¨App Service ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        chmod +x ./azure-deploy.sh
        ./azure-deploy.sh ${{ github.event.inputs.prefix }} ${{ github.event.inputs.environment }}

    - name: Cosmos DB ã®ãƒ‡ãƒ—ãƒ­ã‚¤ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
      if: ${{ github.event.inputs.deploy_cosmos_db == 'true' }}
      run: |
        RESOURCE_GROUP="${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}-rg"
        COSMOSDB_ACCOUNT="${{ github.event.inputs.prefix }}-factory-cosmosdb-${{ github.event.inputs.environment }}"
        
        echo "Cosmos DB ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
        az cosmosdb create \
          --name $COSMOSDB_ACCOUNT \
          --resource-group $RESOURCE_GROUP \
          --kind GlobalDocumentDB \
          --locations regionName=${{ env.AZURE_LOCATION }} failoverPriority=0 isZoneRedundant=False \
          --default-consistency-level "Session" \
          --enable-automatic-failover true \
          --enable-multiple-write-locations false
        
        echo "Cosmos DB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
        az cosmosdb sql database create \
          --account-name $COSMOSDB_ACCOUNT \
          --resource-group $RESOURCE_GROUP \
          --name FactoryManagementDB

    - name: SQL Database ã®ãƒ‡ãƒ—ãƒ­ã‚¤ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
      if: ${{ github.event.inputs.deploy_sql_db == 'true' }}
      run: |
        RESOURCE_GROUP="${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}-rg"
        SQL_SERVER="${{ github.event.inputs.prefix }}-factory-sql-${{ github.event.inputs.environment }}"
        
        echo "SQL Server ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
        az sql server create \
          --name $SQL_SERVER \
          --resource-group $RESOURCE_GROUP \
          --location ${{ env.AZURE_LOCATION }} \
          --admin-user sqladmin \
          --admin-password "${{ secrets.SQL_ADMIN_PASSWORD }}"
        
        echo "SQL Database ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
        az sql db create \
          --server $SQL_SERVER \
          --resource-group $RESOURCE_GROUP \
          --name FactoryManagementDB \
          --service-objective S1
        
        echo "ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¦å‰‡ã‚’è¨­å®šã—ã¦ã„ã¾ã™..."
        az sql server firewall-rule create \
          --server $SQL_SERVER \
          --resource-group $RESOURCE_GROUP \
          --name AllowAzureServices \
          --start-ip-address 0.0.0.0 \
          --end-ip-address 0.0.0.0

    - name: ç™ºè¡Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨Secretsæ›´æ–°
      run: |
        APP_NAME="${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}"
        RESOURCE_GROUP="${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}-rg"
        
        echo "ç™ºè¡Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
        PUBLISH_PROFILE=$(az webapp deployment list-publishing-profiles \
          --name $APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --xml)
        
        echo "::add-mask::$PUBLISH_PROFILE"
        echo "PUBLISH_PROFILE=$PUBLISH_PROFILE" >> $GITHUB_ENV
        
        echo "ğŸ“‹ æ¬¡ã®æ‰‹é †:"
        echo "1. GitHub Secretsã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:"
        echo "   - AZURE_WEBAPP_NAME_${{ github.event.inputs.environment | upper }}: $APP_NAME"
        echo "   - AZURE_WEBAPP_PUBLISH_PROFILE_${{ github.event.inputs.environment | upper }}: <ç™ºè¡Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«>"
        echo "2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"

    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®ã‚µãƒãƒªãƒ¼
      run: |
        echo "ğŸ‰ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ!"
        echo ""
        echo "ğŸ“‹ ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹:"
        echo "  - ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: ${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}-rg"
        echo "  - Web App: ${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}"
        echo "  - Storage Account: ${{ github.event.inputs.prefix }}factory${{ github.event.inputs.environment }}"
        echo "  - Key Vault: ${{ github.event.inputs.prefix }}-factory-kv-${{ github.event.inputs.environment }}"
        echo "  - Application Insights: ${{ github.event.inputs.prefix }}-factory-insights-${{ github.event.inputs.environment }}"
        if [ "${{ github.event.inputs.deploy_cosmos_db }}" = "true" ]; then
          echo "  - Cosmos DB: ${{ github.event.inputs.prefix }}-factory-cosmosdb-${{ github.event.inputs.environment }}"
        fi
        if [ "${{ github.event.inputs.deploy_sql_db }}" = "true" ]; then
          echo "  - SQL Server: ${{ github.event.inputs.prefix }}-factory-sql-${{ github.event.inputs.environment }}"
        fi
        echo ""
        echo "ğŸŒ Web App URL: https://${{ github.event.inputs.prefix }}-factory-management-${{ github.event.inputs.environment }}.azurewebsites.net"